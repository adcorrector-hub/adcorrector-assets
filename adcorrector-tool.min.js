var AdCorrector=function(){var e=null,t={},a=["image/jpeg","image/jpg","image/png","image/webp"];function n(e){var t=document.getElementById("ac-sr-announcements");t&&(t.textContent=e,setTimeout(function(){t.textContent=""},1e3))}function o(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.textContent.substring(0,1e3)}function r(){try{var e=document.getElementById("ac-uploadSection"),t=document.getElementById("ac-fileInput"),a=document.getElementById("ac-boardType");if(!e||!t||!a)return void console.error("Ad Corrector init aborted: missing required DOM nodes.",{uploadSection:!!e,fileInput:!!t,boardType:!!a});if(!window.FileReader)return console.error("FileReader API not supported"),void alert("Your browser does not support file uploads. Please use a modern browser.");e.addEventListener("click",function(){t.click()}),e.addEventListener("dragover",function(t){t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",function(){e.classList.remove("dragover")}),e.addEventListener("drop",function(t){t.preventDefault(),e.classList.remove("dragover");var a=t.dataTransfer.files[0];a&&a.type&&0===a.type.indexOf("image/")?i(a):alert("Please drop an image file (JPG, PNG, or WebP)")}),t.addEventListener("change",function(e){var t=e.target.files[0];t&&i(t)}),a.addEventListener("change",function(e){var t=document.getElementById("ac-customSizeGroup"),a=document.getElementById("ac-viewingSpeed"),n=document.getElementById("ac-viewingDistance");switch(e.target.value){case"bulletin":a.value=65,n.value=600,t.style.display="none";break;case"poster":a.value=45,n.value=300,t.style.display="none";break;case"street":a.value=25,n.value=100,t.style.display="none";break;case"custom":a.value=55,n.value=500,t.style.display="flex"}});var n=document.getElementById("ac-headlineText"),o=document.getElementById("ac-ctaText"),r=document.getElementById("ac-bodyText");function l(){var e=n.value.trim()?n.value.trim().split(/\s+/).length:0,t=o.value.trim()?o.value.trim().split(/\s+/).length:0,a=r.value.trim()?r.value.trim().split(/\s+/).length:0,i=e+t+a;document.getElementById("ac-headlineCount").textContent=e,document.getElementById("ac-ctaCount").textContent=t,document.getElementById("ac-bodyCount").textContent=a,document.getElementById("ac-totalCount").textContent=i;var l=document.getElementById("ac-wordCountDisplay"),c=document.getElementById("ac-wordAdvice");if(i>0){l.style.display="block";var d=document.getElementById("ac-boardType"),s=d?d.value:"bulletin",u=7,h=12;"poster"===s?(u=10,h=18):"street"===s&&(u=12,h=20);var m="",g="#2389ff";i<=u?(m="Ideal: this format performs best with concise copy of "+u+" words or fewer.",g="#2b8a3e"):i<=h?(m="Borderline: this amount of copy may be harder to read quickly for this format.",g="#ffc107"):(m="Too much copy for this OOH format. Aim for around "+u+" words.",g="#ff6b6b"),c.textContent=m,c.style.color=g}else l.style.display="none",c.textContent=""}n.addEventListener("input",l),o.addEventListener("input",l),r.addEventListener("input",l),l(),console.log("Ad Corrector initialized successfully")}catch(c){console.error("Initialization error:",c),alert("Error initializing tool. Please refresh the page.")}}function i(r){try{var i=function(e){return e?e.size>10485760?{valid:!1,error:"File size exceeds 10MB limit. Please use a smaller image."}:-1===a.indexOf(e.type)?{valid:!1,error:"Invalid file type. Please upload a JPG, PNG, or WebP image."}:{valid:!0}:{valid:!1,error:"No file selected"}}(r);if(!i.valid)return alert(i.error),void n(i.error);n("File uploaded successfully. Processing image...");var c=new FileReader;c.onerror=function(){alert("Error reading file. Please try again."),n("Error reading file")},c.onload=function(a){(e=new Image).onerror=function(){alert("Error loading image. Please ensure the file is a valid image."),n("Error loading image"),e=null},e.onload=function(){var a;(a=e,new Promise(function(e){var t=4e3;if(a.width<=t&&a.height<=t)e(a);else{var n=Math.min(t/a.width,t/a.height),o=Math.floor(a.width*n),r=Math.floor(a.height*n),i=document.createElement("canvas");i.width=o,i.height=r,i.getContext("2d").drawImage(a,0,0,o,r);var l=new Image;l.onload=function(){console.log("Image resized from "+a.width+"x"+a.height+" to "+o+"x"+r),e(l)},l.src=i.toDataURL("image/jpeg",.9)}})).then(function(a){var i,c;e=a,"undefined"!=typeof gtag&&gtag("event","upload_image",{event_category:"Tool Usage",event_label:"Image Upload Success",file_size_kb:Math.round(r.size/1024)}),document.getElementById("ac-uploadSection").style.display="none",document.getElementById("ac-formSection").style.display="block",n("Image loaded. Please fill in the design details form."),((c=(i=e).width/i.height)<1.5||c>4)&&i.width>1e3&&document.getElementById("ac-photoWarning").classList.add("show"),function(){var e=document.getElementById("ac-ocrStatus");e&&e.parentNode&&e.parentNode.removeChild(e);var t=document.createElement("div");t.id="ac-ocrStatus",t.className="ac-ocr-status",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.innerHTML='<div class="ac-ocr-status-content"><strong style="color: #2389ff;">⏳ Analyzing text in image...</strong><br><span style="color: #666; font-size: 0.9em;">This will take a few seconds</span></div>';var a=document.getElementById("ac-formSection"),n=document.getElementById("ac-photoWarning");a.insertBefore(t,n)}(),function(e){var a=!1,n=setTimeout(function(){a||(console.warn("OCR timed out after 25 seconds"),l("error","Text detection timed out","Please enter your text manually"))},25e3);(function(e){return new Promise(function(a,n){try{console.log("Starting OCR with Tesseract.js v5...");var r=document.createElement("canvas"),i=1200,l=900,c=Math.min(i/e.width,l/e.height,1);r.width=Math.max(1,Math.round(e.width*c)),r.height=Math.max(1,Math.round(e.height*c)),r.getContext("2d").drawImage(e,0,0,r.width,r.height),Tesseract.recognize(r,"eng",{workerPath:"https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",langPath:"https://tessdata.projectnaptha.com/4.0.0",corePath:"https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js",logger:function(e){"recognizing text"===e.status&&console.log("OCR Progress:",Math.round(100*e.progress)+"%")}}).then(function(e){console.log("OCR completed successfully");var n=(e.data.text||"").toString();window.acDetectedText=n;var i=(e.data&&Array.isArray(e.data.words)?e.data.words:[]).filter(function(e){var t=(e.text||"").trim(),a="number"==typeof e.confidence?e.confidence:0;return t.length>=2&&a>=65&&/[A-Za-z]/.test(t)}),l=0;i.length&&(l=i.reduce(function(e,t){return e+t.confidence},0)/i.length);var c=i.map(function(e){return e.text.trim()}).join(" ").trim();window.acReliableDetectedText=c;var d=c.length>=10&&l>=70;d||(window.acReliableDetectedText=""),window.acDetectedText=(n||"").toString();var s=!1;try{if(e&&e.data&&Array.isArray(e.data.words)){var u=[],h=[],m=r.width,g=r.height;e.data.words.forEach(function(e){if(e&&e.text&&e.text.trim()){var t=e.bbox;t&&"number"==typeof t.x0&&"number"==typeof t.y0&&(u.push({x0:Math.max(0,Math.min(1,t.x0/m)),y0:Math.max(0,Math.min(1,t.y0/g)),x1:Math.max(0,Math.min(1,t.x1/m)),y1:Math.max(0,Math.min(1,t.y1/g))}),h.push({x0:Math.max(0,Math.min(1,t.x0/m)),y0:Math.max(0,Math.min(1,t.y0/g)),x1:Math.max(0,Math.min(1,t.x1/m)),y1:Math.max(0,Math.min(1,t.y1/g)),text:(e.text||"").trim(),conf:"number"==typeof e.confidence?e.confidence:0}))}}),u.length?(t.ocrBoxes=u,t.ocrWordBoxes=h,console.log("Stored OCR bounding boxes for heatmap:",u.length)):t.ocrBoxes=[]}else t.ocrBoxes=[]}catch(e){console.warn("Error processing OCR bounding boxes:",e),t.ocrBoxes=[]}var y=(window.acReliableDetectedText||"").toString().trim();if(y.length){var v=y.split("\n").map(function(e){return e.trim()}).filter(function(e){return e.length>2}),f=document.getElementById("ac-headlineText"),p=document.getElementById("ac-ctaText"),w=document.getElementById("ac-bodyText");if(f.value="",p.value="",w.value="",f.classList.remove("ac-auto-filled"),p.classList.remove("ac-auto-filled"),w.classList.remove("ac-auto-filled"),document.getElementById("ac-headlineBadge").style.display="none",document.getElementById("ac-ctaBadge").style.display="none",document.getElementById("ac-bodyBadge").style.display="none",f.value=o(v[0]||y),f.classList.add("ac-auto-filled"),document.getElementById("ac-headlineBadge").style.display="inline",s=!0,v.length>=2&&(p.value=o(v[v.length-1]),p.classList.add("ac-auto-filled"),document.getElementById("ac-ctaBadge").style.display="inline"),v.length>=3){var b=v.slice(1,-1);w.value=o(b.join(" ").trim()),w.classList.add("ac-auto-filled"),document.getElementById("ac-bodyBadge").style.display="inline"}}setTimeout(function(){var e=document.getElementById("ac-headlineText").value.trim()?document.getElementById("ac-headlineText").value.trim().split(/\s+/).length:0,t=document.getElementById("ac-ctaText").value.trim()?document.getElementById("ac-ctaText").value.trim().split(/\s+/).length:0,a=document.getElementById("ac-bodyText").value.trim()?document.getElementById("ac-bodyText").value.trim().split(/\s+/).length:0,n=e+t+a;document.getElementById("ac-headlineCount").textContent=e,document.getElementById("ac-ctaCount").textContent=t,document.getElementById("ac-bodyCount").textContent=a,document.getElementById("ac-totalCount").textContent=n,n>0&&(document.getElementById("ac-wordCountDisplay").style.display="block")},100),a(s)}).catch(function(e){console.error("OCR processing error:",e),n(e)})}catch(e){console.error("OCR setup error:",e),n(e)}})})(e).then(function(e){if(a=!0,clearTimeout(n),e){var t=(document.getElementById("ac-headlineText").value+" "+document.getElementById("ac-ctaText").value).trim().split(/\s+/).filter(function(e){return e}).length;"undefined"!=typeof gtag&&gtag("event","ocr_complete",{event_category:"Tool Performance",event_label:"OCR Success",words_detected:t}),l("success","Auto-detected "+t+" words!","Edit below if needed, then click Analyze")}else"undefined"!=typeof gtag&&gtag("event","ocr_complete",{event_category:"Tool Performance",event_label:"OCR Failed",words_detected:0}),l("error","Could not detect text in image","Please type your headline & CTA manually")}).catch(function(e){a=!0,clearTimeout(n),console.error("OCR error:",e),"undefined"!=typeof gtag&&gtag("event","ocr_complete",{event_category:"Tool Performance",event_label:"OCR Error",words_detected:0}),l("error","Text detection failed","Please enter your text manually")})}(e)})},e.src=a.target.result},c.readAsDataURL(r)}catch(e){console.error("File upload error:",e),alert("Error uploading file. Please try again."),n("Error uploading file")}}function l(e,t,a){var r,i,l,c=document.getElementById("ac-ocrStatus");c&&("success"===e?(r="#2b8a3e",i="✓",n(t+". "+(l=a||"You can edit the text below if needed"))):"error"===e&&(r="#ff6b6b",i="⚠️",n(t+". "+(l=a||"Please type your headline and CTA manually below"))),c.innerHTML='<div class="ac-ocr-status-content"><strong style="color: '+r+';">'+i+" "+o(t)+'</strong><br><span style="color: #666; font-size: 0.9em;">'+o(l)+"</span></div>",c.style.borderLeftColor=r,"success"===e&&setTimeout(function(){c&&(c.style.transition="opacity 0.5s ease",c.style.opacity="0",setTimeout(function(){c&&c.parentNode&&c.parentNode.removeChild(c)},500))},6e3))}function c(e){var a=t.ocrWordBoxes||[];if(!e||!e.trim()||0===a.length)return null;var n=e.toLowerCase().trim(),o=n.replace(/https?:\/\//g,"").replace(/[^\w.@]+/g," ").split(/\s+/).filter(Boolean),r=/\b(www\.)|(\.(com|net|org|io|co|ai|edu|gov|info|biz|us|ca|uk)\b)/i.test(e),i=-1!==n.indexOf("@"),l=/(?:\+?1\s*)?(?:\(\s*\d{3}\s*\)|\d{3})[-.\s]*\d{3}[-.\s]*\d{4}\b/.test(e);function c(e){if(!e)return!1;var t=e.toLowerCase();if(r&&(-1!==t.indexOf("www")||-1!==t.indexOf(".com")||-1!==t.indexOf(".net")||-1!==t.indexOf(".org")))return!0;if(i&&-1!==t.indexOf("@"))return!0;if(l&&t.replace(/\D/g,"").length>=7)return!0;for(var a=0;a<o.length;a++){var n=o[a];if(!(n.length<3)&&-1!==t.indexOf(n))return!0}return!1}for(var d=[],s=0;s<a.length;s++){var u=a[s];u&&u.text&&(u.conf<55||c(u.text)&&d.push(u))}if(!d.length)return null;for(var h=1,m=1,g=0,y=0,v=0;v<d.length;v++){var f=d[v];h=Math.min(h,f.x0),m=Math.min(m,f.y0),g=Math.max(g,f.x1),y=Math.max(y,f.y1)}return{x0:h,y0:m,x1:g,y1:y}}function d(e){var a=t.ocrBoxes||[];if(!e||0===a.length)return.1;var n=Math.max(0,e.x0-.1),o=Math.max(0,e.y0-.1),r=Math.min(1,e.x1+.1),i=Math.min(1,e.y1+.1);function l(e,t){return!(e.x1<t.x0||e.x0>t.x1||e.y1<t.y0||e.y0>t.y1)}for(var c=0,d=0;d<a.length;d++){var s=a[d];s&&(l(s,{x0:n,y0:o,x1:r,y1:i})&&!l(s,e)&&c++)}return c>=14?.28:c>=9?.2:c>=5?.12:.06}function s(e,t){t=t||"direct";var a=Number(e.readability)||0,n=Number(e.contrast)||0,o=Number(e.clarity)||0,r=Number(e.colors)||0,i=Number(e.composition)||0,l=Number(e.cta)||0;if("brand"===t){var c=a*(.18/.84)+n*(.16/.84)+o*(.2/.84)+r*(.14/.84)+i*(.16/.84);return Math.round(c)}var d=.18*a+.16*n+.2*o+.14*r+.16*i+.16*l;return Math.round(d)}function u(e){var t=document.querySelectorAll("#ac-modeDirect"),a=document.querySelectorAll("#ac-modeBrand"),n="direct"===e;function o(e,t){e&&(e.classList.remove("ac-mode-active"),t&&e.classList.add("ac-mode-active"))}for(var r=0;r<t.length;r++)o(t[r],n);for(var i=0;i<a.length;i++)o(a[i],!n)}function h(){var e=document.querySelectorAll("#ac-modeDirect"),t=document.querySelectorAll("#ac-modeBrand");function a(e,t){e&&(e.onclick=function(e){e&&e.preventDefault&&e.preventDefault(),window.acScoringMode=t,u(t),function(){if(window.acLastScores&&window.acLastAnalysisData&&window.acLastDetails){var e=window.acLastScores,t=s({readability:e.readability,contrast:e.contrast,clarity:e.clarity,colors:e.colors,composition:e.composition,cta:e.cta},window.acScoringMode),a=m(t);if(window.acLastDetails.avgScore=t,window.acLastDetails.grade=a.full,window.acLastDetails.scoringMode=window.acScoringMode,g(a,t,window.acLastAnalysisData,window.acLastDetails),y(window.acLastAnalysisData),v(window.acLastAnalysisData,window.acLastDetails),"function"==typeof window.peRunFromAdCorrector)try{window.peRunFromAdCorrector({readability:e.readability,contrast:e.contrast,clarity:e.clarity,colors:e.colors,composition:e.composition,cta:e.cta,avgScore:t,grade:a.full,wordCount:window.acLastDetails&&window.acLastDetails.wordCount?window.acLastDetails.wordCount:0,scoringMode:window.acScoringMode})}catch(e){console.error("❌ Persuasion Engine toggle sync failed:",e)}}}()})}for(var n=0;n<e.length;n++)a(e[n],"direct");for(var o=0;o<t.length;o++)a(t[o],"brand");u(window.acScoringMode||"direct")}function m(e){var t="F";e>=90?t="A":e>=80?t="B":e>=70?t="C":e>=60&&(t="D");var a="";if("F"!==t){var n=e%10;n>=7?a="+":n<=2&&(a="-")}return{letter:t,mod:a,full:t+a}}function g(e,t,a,n){var o="string"==typeof e?{letter:e,mod:"",full:e}:e,r=document.getElementById("ac-gradeLetter");r&&(r.textContent=o.full);var i=n&&n.scoringMode?n.scoringMode:window.acScoringMode||"direct",l={key:"readability",label:"Readability",value:999};if(a){var c=[{key:"readability",label:"Readability",value:Number(a.readability)},{key:"contrast",label:"Contrast",value:Number(a.contrast)},{key:"clarity",label:"Clarity",value:Number(a.clarity)},{key:"colors",label:"Colors",value:Number(a.colors)},{key:"composition",label:"Composition",value:Number(a.composition)}];"brand"!==i&&c.push({key:"cta",label:"CTA",value:Number(a.cta)});for(var d=0;d<c.length;d++)isFinite(c[d].value)&&c[d].value<l.value&&(l=c[d])}if((n&&void 0!==n.cta?String(n.cta).trim():"").length>0||"brand"===i){var s="";t>=90?(s="Production-Ready Visibility. Strong structural clarity.",l.value<90?s+=" Primary constraint: "+l.label+" ("+l.value+"%).":s+=" Minor refinements only."):t>=80?(s="Structurally Strong. One constraint limiting peak visibility.",s+=" Primary constraint: "+l.label+" ("+l.value+"%)."):t>=70?(s="Moderate Visibility Risk. Improvement required in "+l.label+" before production.",s+=" Primary constraint: "+l.label+" ("+l.value+"%)."):t>=60?(s="High Visibility Risk. Revision recommended before placement.",s+=" Primary constraint: "+l.label+" ("+l.value+"%)."):(s="Critical Visibility Failure. Redesign required.",s+=" Primary constraint: "+l.label+" ("+l.value+"%).");var u=document.getElementById("ac-gradeDescription");u&&(u.textContent=s)}else{var h=document.getElementById("ac-gradeDescription");h&&(h.textContent="CTA missing. Add an action plus an anchor (URL, phone, or location cue) before production.")}}function y(e){var t=document.getElementById("ac-metricsGrid");if(t){var a=document.getElementById("ac-ctaText"),n=!(!a||!String(a.value||"").trim().length),o=document.getElementById("ac-headlineText"),r=!(!o||!String(o.value||"").trim().length),i={Readability:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>',Contrast:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M12 3v18"/><path d="M12 3a9 9 0 0 1 0 18"/></svg>',Clarity:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 5v2"/><path d="M12 17v2"/><path d="M5 12h2"/><path d="M17 12h2"/><path d="M7.05 7.05l1.41 1.41"/><path d="M15.54 15.54l1.41 1.41"/><path d="M7.05 16.95l1.41-1.41"/><path d="M15.54 8.46l1.41-1.41"/></svg>',Colors:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="4.5"/><circle cx="17.5" cy="14.5" r="4.5"/><circle cx="8.5" cy="13.5" r="4.5"/></svg>',Composition:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>',CTA:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 15l6 6m-6-6v4.8m0-4.8h4.8"/><rect x="3" y="3" width="9" height="9" rx="1"/><path d="M15 3h3a3 3 0 0 1 3 3v3"/><path d="M3 15v3a3 3 0 0 0 3 3h3"/></svg>'},l={Readability:"How quickly drivers can understand your main message at a glance.",Contrast:"Difference between text and background so copy stays readable.",Clarity:"How clean and decipherable the overall layout feels at speed.",Colors:"How well your colors support legibility and brand recall.",Composition:"Balance, alignment, and visual hierarchy of elements.",CTA:"How visible and action-driven your main call-to-action is."},c=window.acScoringMode||"direct",d=[{label:"Readability",value:e.readability,unit:"%"},{label:"Contrast",value:e.contrast,unit:"%"},{label:"Clarity",value:e.clarity,unit:"%"},{label:"Colors",value:e.colors,unit:"%"},{label:"Composition",value:e.composition,unit:"%"}];"brand"!==c&&d.push({label:"CTA",value:e.cta,unit:"%"});for(var s="",u=0;u<d.length;u++){var h=d[u],m=i[h.label]||"",g=l[h.label]||"",y="";"CTA"!==h.label||n||0!==Number(h.value)||(y='<div class="ac-metric-note"><div class="ac-metric-note-warn">CTA missing</div><div class="ac-metric-note-sub">Add CTA text to score this category.</div></div>'),"Readability"!==h.label||r||0!==Number(h.value)||(y='<div class="ac-metric-note"><div class="ac-metric-note-warn">Headline missing</div><div class="ac-metric-note-sub">Add headline text to score this category.</div></div>');var v=x(h.label,Number(h.value)),f=b(h.label,Number(h.value)),p='<ul style="margin:8px 0 0 16px;padding:0;"><li style="margin:0 0 6px 0;">'+w(f[0]||"")+'</li><li style="margin:0;">'+w(f[1]||"")+"</li></ul>";s+='<div class="ac-metric-card" role="button" tabindex="0" aria-expanded="false" aria-label="'+w(h.label)+' score. Click for details." title="'+w(g)+'" data-metric="'+w(h.label)+'"><div class="ac-metric-header"><div class="ac-metric-header-left"><span class="ac-metric-icon">'+m+'</span><span class="ac-metric-label">'+w(h.label)+'</span></div></div><div class="ac-metric-value-row"><div class="ac-metric-value">'+w(h.value)+w(h.unit)+'</div><span class="ac-metric-chevron" aria-hidden="true"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9l6 6 6-6" stroke="rgba(0,0,0,0.65)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>'+y+'<div class="ac-metric-bar" role="progressbar" aria-valuenow="'+w(h.value)+'" aria-valuemin="0" aria-valuemax="100" aria-label="'+w(h.label)+' progress bar"><div class="ac-metric-bar-fill" style="width: '+w(h.value)+'%"></div></div><div class="ac-metric-expand" aria-hidden="true"><h4>What this means</h4><p style="margin:0 0 10px 0;color:rgba(0,0,0,0.75);font-size:13px;line-height:1.35;">'+w(v)+'</p><h4>Fix guidance</h4><div style="color:rgba(0,0,0,0.75);font-size:13px;line-height:1.35;">'+p+"</div></div></div>"}t.innerHTML=s,setTimeout(function(){for(var e=document.querySelectorAll(".adcorrector-tool .ac-metric-bar-fill"),t=0;t<e.length;t++){var a=e[t],n=a.parentNode.getAttribute("aria-valuenow");a.style.width=(n||"0")+"%"}},100),t.onclick=null,t.onkeydown=null,t.onclick=function(e){for(var a=e.target;a&&a!==t&&!a.classList.contains("ac-metric-card");)a=a.parentNode;a&&a.classList&&a.classList.contains("ac-metric-card")&&M(a)},t.onkeydown=function(e){var t=e.key||e.keyCode;if("Enter"===t||" "===t||13===t||32===t){var a=e.target;a&&a.classList&&a.classList.contains("ac-metric-card")&&(e.preventDefault(),M(a))}}}function w(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function b(e,t){return"Readability"===e?r||0!==Number(t)?t>=85?["Keep the message this tight","Avoid adding extra copy that slows scan time"]:t>=70?["Trim 1–3 words","Remove filler words and tighten the verb"]:["Reduce total word count","Make the headline the hero and cut body copy"]:["Add headline text to score this category","Keep headline ≤ 7 words for highway formats"]:"Contrast"===e?t>=85?["Maintain this contrast","Avoid placing text over busy photo areas"]:t>=70?["Increase text/background separation","Add a solid field or darker overlay behind text"]:["Use high-contrast color pairs (light on dark or dark on light)","Avoid mid-tone text on mid-tone backgrounds"]:"Clarity"===e?t>=85?["Layout reads clean at speed","Keep hierarchy simple and stable"]:t>=70?["Reduce visual noise near text","Increase spacing between headline, CTA, and logo"]:["Simplify the layout","Remove secondary elements competing with the message"]:"Colors"===e?t>=85?["Palette supports legibility","Keep accents intentional and limited"]:t>=70?["Reduce competing accent colors","Use one dominant field color + one accent"]:["Simplify the palette","Avoid too many similar mid-tone colors that blur hierarchy"]:"Composition"===e?t>=85?["Hierarchy is balanced","Keep alignment consistent across elements"]:t>=70?["Add more whitespace around the message","Rebalance visual weight (logo vs headline vs CTA)"]:["Rebuild hierarchy: headline first, CTA second, brand third","Remove clutter and align elements to a grid"]:n||0!==Number(t)?t>=85?["CTA is strong—keep it dominant","Don’t bury it in a corner or low-contrast area"]:t>=70?["Make CTA bigger and higher contrast","Add a concrete anchor (URL/phone/location)"]:["CTA needs dominance: bigger, bolder, higher contrast","Use an action verb + anchor (URL/phone/location)"]:["Add CTA text to score this category","Include a URL, phone, or location cue"]}function x(e,t){return"CTA"!==e||n||0!==Number(t)?"Readability"!==e||r||0!==Number(t)?t>=85?"Strong. This supports fast speed-view comprehension.":t>=70?"Decent, but there is room to tighten for speed-view conditions.":"Weak. This will likely fail at distance and motion.":"No headline text was provided, so Readability cannot be scored.":"No CTA text was provided, so this category cannot be scored."}function M(e){if(e){for(var a=t.querySelectorAll(".ac-metric-card"),n=0;n<a.length;n++)if(a[n]!==e){a[n].classList.remove("ac-expanded"),a[n].setAttribute("aria-expanded","false");var o=a[n].querySelector(".ac-metric-expand");o&&o.setAttribute("aria-hidden","true")}if(e.classList.contains("ac-expanded")){e.classList.remove("ac-expanded"),e.setAttribute("aria-expanded","false");var r=e.querySelector(".ac-metric-expand");r&&r.setAttribute("aria-hidden","true")}else{e.classList.add("ac-expanded"),e.setAttribute("aria-expanded","true");var i=e.querySelector(".ac-metric-expand");i&&i.setAttribute("aria-hidden","false")}}}}function v(e,t){var a=!(!t||!(t.hasDeclaredText||t.wordCount>0)),n=document.getElementById("ac-fixesList"),r=document.getElementById("ac-workingList"),i=t&&t.scoringMode?t.scoringMode:window.acScoringMode||"direct",l="brand"!==i,c=(t&&"number"==typeof t.avgScore?t.avgScore:s({readability:e.readability,contrast:e.contrast,clarity:e.clarity,colors:e.colors,composition:e.composition,cta:e.cta},i),"A"===(t&&t.grade?String(t.grade):"").charAt(0)),d=document.getElementById("ac-fixes-title");d&&(d.textContent=c?"Top 3 Recommendations":"Top 3 Improvements");var u=Math.min(e.readability,e.contrast),h=u>=50,m=u<30,g="absent";l&&(g="absent",(t&&t.cta?String(t.cta).trim():"").length>0&&(g=e.cta>=90?"strong":e.cta<75?"weak":"ok"));var y=[{key:"readability",label:"Readability",value:e.readability},{key:"contrast",label:"Contrast",value:e.contrast},{key:"clarity",label:"Clarity",value:e.clarity},{key:"colors",label:"Colors",value:e.colors},{key:"composition",label:"Composition",value:e.composition}];l&&y.push({key:"cta",label:"CTA",value:e.cta});for(var v=y[0],f=y[0],p=1;p<y.length;p++){var w=y[p];w.value>v.value&&(v=w),w.value<f.value&&(f=w)}var b=v.value-f.value>=20,x=[];if(a){if(e.readability<70){var M=t.wordCount||0;M>15?x.push("Reduce total word count for faster scan time (currently "+M+" words)"):M>10?x.push("Shorten copy so it can be understood quickly at typical viewing distance"):x.push("Improve text readability and simplify messaging")}}else x.push("Add headline and CTA text in the fields to score Readability");if(m&&(x.length<3&&e.contrast<70&&x.push("Increase contrast between text and background so copy holds up at distance"),x.length<3&&a&&e.readability<70&&x.push("Shorten copy so it can be understood quickly at typical viewing distance")),l&&x.length<3&&("absent"===g?x.push("Add a clear call-to-action with contact info (URL, phone, or location)"):"weak"===g&&x.push("CTA needs more dominance. Make it bigger, bolder, or higher contrast.")),x.length<3&&e.contrast<70&&x.push("Increase contrast between text and background"),x.length<3&&e.clarity<70&&x.push("Simplify design for better highway speed visibility"),x.length<3&&e.colors<70&&x.push("Improve color harmony and brand consistency"),x.length<3&&e.composition<70&&x.push("Balance visual elements and increase white space"),x.length<3&&e.readability>=70&&e.readability<80&&x.push("Consider reducing word count slightly for faster comprehension"),x.length<3&&e.colors>=70&&e.colors<80&&x.push("Refine the color palette for stronger brand recall"),x.length<3&&e.composition>=70&&e.composition<80&&x.push("Increase white space for better visual hierarchy"),x.length<3&&e.clarity>=70&&e.clarity<80&&x.push("Confirm visibility under real-world viewing conditions before production"),x.length<3&&e.contrast>=70&&e.contrast<80&&x.push("Consider increasing contrast for optimal readability"),b&&x.length<3)if("readability"!==f.key||"contrast"!==v.key&&"colors"!==v.key)if(l&&"cta"===f.key&&v.value>=75){for(var C=!1,I=0;I<x.length;I++)if(-1!==String(x[I]).toLowerCase().indexOf("cta")){C=!0;break}C||"strong"===g||x.push("Core design scores well, but CTA is weaker. Improve CTA dominance and clarity.")}else x.push("There is a gap between "+v.label.toLowerCase()+" ("+v.value+"%) and "+f.label.toLowerCase()+" ("+f.value+"%). Bring the weaker area up for balance.");else x.push("Your "+v.label.toLowerCase()+" is strong, but readability is weaker. Simplify text and hierarchy so the message scans instantly.");for(var E=["Test design at actual viewing distance (500+ feet)","Print proof at reduced scale to verify readability","Consider A/B testing with slight variations","Get feedback from someone unfamiliar with your brand","Review design on mobile device at arm's length"],B=0;B<E.length&&x.length<3;B++)x.push(E[B]);for(var A=x.slice(0,3),T="",S=c?'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2389ff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:8px;flex-shrink:0;"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>':'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:8px;flex-shrink:0;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',k=0;k<A.length;k++)T+="<li>"+S+o(A[k])+"</li>";n.innerHTML=T;var L=[];b&&v.value>=75&&(h||"readability"!==f.key&&"contrast"!==f.key)&&L.push(v.label+" is a standout strength in this design"),e.readability>=70&&h&&L.push("Text is concise and readable"),e.contrast>=70&&e.readability>=50&&L.push("Strong color contrast helps copy hold up at distance"),"strong"===g?L.push("CTA is clear and action-forward"):"weak"===g&&L.push("CTA is present and identifiable"),e.clarity>=70&&L.push("Layout feels clean and organized"),e.colors>=70&&e.contrast>=50&&L.push("Effective color palette"),e.composition>=70&&L.push("Well-balanced composition");var R=L.slice(0,3);0===R.length&&(R=["Professional layout","Brand elements visible","Clear hierarchy"]);for(var D="",P=0;P<R.length;P++)D+='<li><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2b8a3e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:8px;flex-shrink:0;"><circle cx="12" cy="12" r="10"/><polyline points="16 8 10 14 7 11"/></svg>'+o(R[P])+"</li>";r.innerHTML=D}function f(){var t=document.getElementById("ac-speedCanvas");if(t&&e){var a=t.getContext("2d");t.width=e.width,t.height=e.height;var n=parseInt(document.getElementById("ac-viewingSpeed").value,10),o=parseInt(document.getElementById("ac-viewingDistance").value,10),r=isNaN(n)?65:n,i=isNaN(o)?600:o;r=Math.min(Math.max(r,0),90),i=Math.min(Math.max(i,0),1500);var l=document.getElementById("ac-speedCaption");if(l&&(l.textContent=r<=5?"Stopped / Crawling • "+Math.round(i)+" ft":Math.round(r)+" mph • "+Math.round(i)+" ft"),r<=5)return a.clearRect(0,0,t.width,t.height),a.globalAlpha=1,a.filter="none",void a.drawImage(e,0,0);var c=(r-30)/60;c<0&&(c=0);var d=(i-200)/1300;d<0&&(d=0);var s=.5+2.5*c+1.5*d;s=Math.min(Math.max(s,.5),6),a.clearRect(0,0,t.width,t.height),a.filter="blur("+s+"px)",a.drawImage(e,0,0);var u=2+Math.round(4*c),h=40+40*d;a.filter="none",a.globalAlpha=.15+.35*c;for(var m=1;m<=u;m++){var g=h/u*m;a.drawImage(e,-g,0)}a.globalAlpha=1}}return window.acScoringMode=window.acScoringMode||"direct",window.acLastScores=window.acLastScores||null,window.acLastAnalysisData=window.acLastAnalysisData||null,window.acLastDetails=window.acLastDetails||null,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r(),{analyzeAd:function(){try{if(!e)return alert("Please upload an image first"),void n("Please upload an image first");var a=function(){var e=document.getElementById("ac-viewingSpeed"),t=document.getElementById("ac-viewingDistance"),a=parseInt(e.value,10),o=parseInt(t.value,10),r=!1;isNaN(a)&&(a=65,r=!0),isNaN(o)&&(o=600,r=!0);var i=Math.min(Math.max(a,0),90),l=Math.min(Math.max(o,50),2e3);return i===a&&l===o||(r=!0),e.value=i,t.value=l,r&&n("Viewing speed and distance adjusted to realistic ranges for analysis."),{speed:i,distance:l}}();document.getElementById("ac-viewingSpeed").value=a.speed,document.getElementById("ac-viewingDistance").value=a.distance;var r=o(document.getElementById("ac-headlineText").value),i=o(document.getElementById("ac-ctaText").value),l=o(document.getElementById("ac-bodyText").value),u=acHasUsableTextInImage((window.acReliableDetectedText||window.acDetectedText||"").toString()),h=(r+" "+i+" "+l).trim().length>0;if(!u&&!h)return document.getElementById("ac-resultsSection").style.display="none",document.getElementById("ac-loadingSection").style.display="none",document.getElementById("ac-formSection").style.display="block",void alert("Text could not be evaluated reliably.\n\nThis image does not contain enough clear text for analysis.\n\nTo continue, please reset and upload a flat outdoor ad artwork file with clearly legible text.");var p=(r+" "+i+" "+l).trim().split(/\s+/).filter(function(e){return e}).length;"undefined"!=typeof gtag&&gtag("event","analyze_billboard",{event_category:"Tool Usage",event_label:"Analyze Button Click",total_words:p,has_headline:r?"yes":"no",has_cta:i?"yes":"no"}),n("Analyzing billboard. This may take a few seconds."),document.getElementById("ac-formSection").style.display="none",document.getElementById("ac-loadingSection").style.display="block",setTimeout(function(){try{console.log("Starting analysis..."),function(){try{console.log("=== Starting Performance Analysis ===");var a=o(document.getElementById("ac-headlineText").value),n=o(document.getElementById("ac-ctaText").value),r=o(document.getElementById("ac-bodyText").value),i=parseInt(document.getElementById("ac-viewingSpeed").value)||65,l=parseInt(document.getElementById("ac-viewingDistance").value)||600;console.log("Input values:",{headline:a,cta:n,bodyText:r,speed:i,distance:l});var u=a.trim()?a.trim().split(/\s+/).length:0,h=n.trim()?n.trim().split(/\s+/).length:0,p=r.trim()?r.trim().split(/\s+/).length:0,w=u+h+p,b=(a.trim().length,n.trim().length,w>0);console.log("Word counts:",{headlineWords:u,ctaWords:h,bodyWords:p,totalWords:w});var x=100;0===w?x=0:(x=w<=7?100:w<=10?90-5*(w-7):w<=15?75-3*(w-10):w<=20?60-4*(w-15):Math.max(0,40-2*(w-20)),0===p&&u<=7?x=Math.min(100,x+5):p>10&&(x-=15),h>5?x-=10:h>=1&&h<=3&&(x=Math.min(100,x+5))),x=Math.max(0,Math.min(100,Math.round(x))),console.log("Readability score:",x);var M=function(e){try{console.log("Analyzing contrast...");var t=document.createElement("canvas"),a=t.getContext("2d");t.width=Math.min(e.width,800),t.height=Math.min(e.height,600),a.drawImage(e,0,0,t.width,t.height);for(var n=a.getImageData(0,0,t.width,t.height).data,o=[],r=0;r<n.length;r+=40){var i=.2126*n[r]+.7152*n[r+1]+.0722*n[r+2];o.push(i)}if(0===o.length)return console.warn("No luminance data, using default"),75;var l,c=Math.min.apply(null,o),d=(Math.max.apply(null,o)+.05)/(c+.05);return l=d>=10?100:d>=7?85+(d-7)/3*15:d>=4.5?70+(d-4.5)/2.5*15:d>=3?50+(d-3)/1.5*20:Math.max(0,d/3*50),console.log("Contrast score:",Math.round(l)),Math.round(l)}catch(e){return console.error("Contrast analysis error:",e),75}}(e),C=function(e,t,a,n,o){try{console.log("Analyzing clarity...");var r=88,i=0;t>55?i=8*Math.pow((t-55)/10,1.3):t<35&&(r+=.3*(35-t));var l=0;a>800?l=(a-800)/100*3:a<200&&(l=(200-a)/50*4);var c=document.createElement("canvas"),d=c.getContext("2d");c.width=220,c.height=165,d.drawImage(e,0,0,c.width,c.height);var s,u,h,m,g=d.getImageData(0,0,c.width,c.height).data,y=c.width,v=c.height,f=new Array(y*v);for(s=0;s<y*v;s++)m=4*s,f[s]=.2126*g[m]+.7152*g[m+1]+.0722*g[m+2];var p=[];for(h=1;h<v-1;h+=2)for(u=1;u<y-1;u+=2){var w=h*y+u,b=f[w+1]-f[w-1],x=f[w+y]-f[w-y],M=Math.sqrt(b*b+x*x);p.push(M)}if(!p.length){console.warn("No sharpness samples, using fallback");var C=r-i-l;return Math.max(0,Math.min(100,Math.round(C)))}p.sort(function(e,t){return e-t});var I=Math.floor(.9*p.length);I<0&&(I=0),I>=p.length&&(I=p.length-1);var E=p[I],B=0,A=0;o>=80&&(A=n<=5?8:n<=9?4:0),(B=E<10?-14:E<18?-8:E<28?-2:E<45?4:E<70?6:3)<=-8&&(A=0);var T=0,S=9;if(t>=70?S-=2:t>=60&&(S-=1),a>=800?S-=2:a>=650&&(S-=1),n>(S=Math.max(5,S))){var k=n-S;T=Math.min(12,2*k),o<70&&(T+=2),o<55&&(T+=2)}var L=r-i-l+B+A-T;return L=Math.max(0,Math.min(100,Math.round(L))),console.log("Clarity score:",L,{p90:Math.round(E),sharpAdj:B,densityBonus:A,densityPenalty:T,wordBudget:S}),L}catch(e){console.error("Clarity analysis error:",e);var R=0;a>800&&(R=(a-800)/100*3);var D=85-(t>55?Math.max(0,.5*(t-55)):0)-R;return Math.max(0,Math.min(100,Math.round(D)))}}(e,i,l,w,M),I=function(e){try{console.log("Analyzing colors (noise-filtered)...");var t=document.createElement("canvas"),a=t.getContext("2d"),n=420,o=320,r=Math.min(n/e.width,o/e.height,1);t.width=Math.max(1,Math.round(e.width*r)),t.height=Math.max(1,Math.round(e.height*r)),a.drawImage(e,0,0,t.width,t.height);for(var i=a.getImageData(0,0,t.width,t.height).data,l={},c=0,d=0;d<i.length;d+=120){var s=51*Math.floor(i[d]/51)+","+51*Math.floor(i[d+1]/51)+","+51*Math.floor(i[d+2]/51);l[s]=(l[s]||0)+1,c++}if(!c)return 80;for(var u=.002,h=Math.max(30,Math.round(c*u)),m=Object.keys(l),g=[],y={},v=0;v<m.length;v++){var f=m[v];l[f]>=h&&(g.push(f),y[f]=l[f])}if(g.length<2&&m.length>=2){h=Math.max(15,Math.round(.001*c)),g=[],y={};for(var p=0;p<m.length;p++){var w=m[p];l[w]>=h&&(g.push(w),y[w]=l[w])}}g.length||(g=m.slice(0),y=l);var b=g.length,x=g.map(function(e){return{color:e,count:y[e]}}).sort(function(e,t){return t.count-e.count}),M=x[0].count/c*100,C=x[1]?x[1].count/c*100:0,I=90;return b<=1?I-=12:b<=3?I+=6:b<=6?I+=4:I-=b<=9?4:b<=14?12:22,M<12?I-=10:M>=55&&M<=92?I+=4:M>97&&(I-=8),C>=4&&C<=28&&M>=55&&(I+=4),I=Math.max(0,Math.min(100,Math.round(I))),console.log("Color score:",I,{uniqueColors:b,domPct:Math.round(M),secondPct:Math.round(C),noiseThreshold:h}),I}catch(e){return console.error("Color analysis error:",e),80}}(e),E=function(e){try{console.log("Analyzing composition...");var t=document.createElement("canvas"),a=t.getContext("2d");t.width=Math.min(e.width,400),t.height=Math.min(e.height,300),a.drawImage(e,0,0,t.width,t.height);for(var n=a.getImageData(0,0,t.width,t.height).data,o=100,r=0,i=40,l=0;l<t.height-1;l+=10)for(var c=0;c<t.width-1;c+=10){var d=4*(l*t.width+c),s=4*(l*t.width+(c+1));if(!(d>=n.length||s>=n.length)){var u=(n[d]+n[d+1]+n[d+2])/3,h=(n[s]+n[s+1]+n[s+2])/3;Math.abs(u-h)>i&&r++}}var m=Math.floor(t.height/10)*Math.floor(t.width/10),g=m>0?r/m:.2;g>.5?o-=20:(g>.35||g<.1)&&(o-=10);for(var y=0,v=0,f=0;f<n.length;f+=800){if(!(f+2>=n.length))(n[f]+n[f+1]+n[f+2])/3>200&&y++,v++}var p=v>0?y/v:.3;return p<.15?o-=15:p>.6?o-=10:p>=.2&&p<=.4&&(o+=5),console.log("Composition score:",Math.max(0,Math.min(100,Math.round(o)))),Math.max(0,Math.min(100,Math.round(o)))}catch(e){return console.error("Composition analysis error:",e),80}}(e),B=0,A=(n||"").trim(),T=A.toLowerCase();if(A.length>=2){B=65,h>=1&&h<=3?B+=10:4===h?B+=4:h>4&&(B-=10);for(var S=["call","visit","text","click","buy","get","try","start","join","learn","shop","check","go","visit","open","see","order","book","sign","scan","download"],k=!1,L=0;L<S.length;L++)if(-1!==T.indexOf(S[L])){k=!0;break}k&&(B+=10);var R=/\b((https?:\/\/)?(www\.)?[a-z0-9-]+\.(com|net|org|io|co|ai|edu|gov|info|biz|us|ca|uk)(\/\S*)?)\b/i.test(A),D=/(?:\+?1\s*)?(?:\(\s*\d{3}\s*\)|\d{3})[-.\s]*\d{3}[-.\s]*\d{4}\b/.test(A),P=-1!==T.indexOf("@")||-1!==T.indexOf("instagram")||-1!==T.indexOf("ig:")||-1!==T.indexOf("tiktok")||-1!==T.indexOf("facebook")||-1!==T.indexOf("fb")||-1!==T.indexOf("x.com")||-1!==T.indexOf("twitter"),N=/\bqr\b/.test(T)||-1!==T.indexOf("qr code")||-1!==T.indexOf("scan the qr"),O=/\bat\s+\d{1,6}\b/.test(T),z=/\bat\s+[a-z0-9 .'-]{2,}\b(st|street|rd|road|ave|avenue|blvd|boulevard|dr|drive|ln|lane|ct|court|hwy|highway)\b/.test(T),q=-1!==T.indexOf("exit")||-1!==T.indexOf("mile")||-1!==T.indexOf("next to")||-1!==T.indexOf("near ")||O||z,j=D||R||P||N||q;j?D?B+=15:q?B+=12:R?B+=10:P?B+=8:N&&(B+=6):B=Math.min(B,72);for(var _=["learn more","click here","visit us","find out","see more","get started","call now","shop now"],H=!1,U=0;U<_.length;U++)if(-1!==T.indexOf(_[U])){H=!0;break}if(H&&!j&&(B-=10,B=Math.min(B,68)),j&&!k){var W=c(A);if(W){var F=Math.max(0,W.x1-W.x0)*Math.max(0,W.y1-W.y0);B-=F<.006?8:F<.01?5:2}else B-=5}var G=c(A),V=parseInt(document.getElementById("ac-viewingSpeed").value,10),K=parseInt(document.getElementById("ac-viewingDistance").value,10),Y=isNaN(V)?65:V,Z=isNaN(K)?600:K;if(Y=Math.min(Math.max(Y,0),90),Z=Math.min(Math.max(Z,0),1500),A.length>=2&&!G)B-=6;else if(G){var J=function(e){if(!e)return.15;var t=(e.x0+e.x1)/2,a=(e.y0+e.y1)/2,n=Math.min(t,1-t,a,1-a),o=0;o=n<.06?.35:n<.1?.25:n<.16?.15:n<.22?.08:.03;t>.78&&a>.7&&(o+=.12);return Math.min(.5,o)}(G),Q=d(G),X=function(e){if(!e)return.12;var t=Math.max(0,e.x1-e.x0)*Math.max(0,e.y1-e.y0),a=d(e);return t<.004?Math.min(.35,a+.14):t<.007?Math.min(.28,a+.1):Math.min(.22,a+.06)}(G),$=function(e,t,a,n,o){if(!e||!n||!o)return.12;var r=Math.max(1,(e.y1-e.y0)*o),i=(t-30)/60;i<0&&(i=0);var l=(a-200)/1300;l<0&&(l=0);var c=r/(10*(.5+2.5*i+1.5*l));return c<.7?.32:c<1?.22:c<1.4?.14:.06}(G,Y,Z,e.width,e.height),ee=J+Q+X+$,te=Math.round(28*ee);B-=te}}else 1===A.length&&(B=20);B=Math.max(0,Math.min(100,Math.round(B))),console.log("CTA score:",B),t.readability=x,t.contrast=M,t.clarity=C,t.colors=I,t.composition=E,t.cta=B,console.log("All scores:",t);var ae=s({readability:x,contrast:M,clarity:C,colors:I,composition:E,cta:B},window.acScoringMode),ne=m(ae);console.log("Average score:",ae,"Grade:",ne);var oe=ne.full;setTimeout(function(){if("function"==typeof window.peRunFromAdCorrector)try{console.log("✅ Sending data to Persuasion Engine..."),window.peRunFromAdCorrector({readability:x,contrast:M,clarity:C,colors:I,composition:E,cta:B,avgScore:ae,grade:oe,wordCount:w}),console.log("✅ Data sent successfully to Persuasion Engine")}catch(e){console.error("❌ Persuasion Engine hook error:",e)}else console.warn("⚠️ Persuasion Engine not found on page. Make sure it's loaded.")},500);var re={headline:a,cta:n,wordCount:w,hasDeclaredText:b,grade:ne.full,avgScore:ae,scoringMode:window.acScoringMode};window.acLastScores={readability:x,contrast:M,clarity:C,colors:I,composition:E,cta:B},window.acLastAnalysisData=t,window.acLastDetails=re,g(ne,ae,t,re),y(t),v(t,re),function(){try{a=document.getElementById("ac-originalCanvas"),n=a.getContext("2d"),a.width=e.width,a.height=e.height,n.drawImage(e,0,0),f(),function(){var a=document.getElementById("ac-heatmapCanvas"),n=a.getContext("2d");if(!e)return;a.width=e.width,a.height=e.height,n.clearRect(0,0,a.width,a.height),n.drawImage(e,0,0,a.width,a.height);var o=16,r=9,i=document.createElement("canvas");i.width=160,i.height=90;var l=i.getContext("2d");l.drawImage(e,0,0,i.width,i.height);for(var c=l.getImageData(0,0,i.width,i.height).data,d=i.width/o,s=i.height/r,u=[],h=t&&Array.isArray(t.ocrBoxes)&&t.ocrBoxes.length>0,m=h?t.ocrBoxes:[],g=0;g<r;g++)for(var y=0;y<o;y++){for(var v=Math.floor(y*d),f=Math.floor(g*s),p=Math.floor((y+1)*d),w=Math.floor((g+1)*s),b=0,x=0,M=0,C=f;C<w;C++)for(var I=v;I<p;I++){var E=4*(C*i.width+I);if(!(E+2>=c.length)){var B=(c[E]+c[E+1]+(H=c[E+2]))/3;b+=B,x+=B*B,M++}}if(0!==M){var A=b/M,T=x/M-A*A;T<0&&(T=0);var S=T,k=(y+.5)/o,L=(g+.5)/r,R=Math.abs(k-.5),D=Math.abs(L-.45),P=Math.sqrt(R*R+D*D),N=Math.max(0,1-P/.7),O=0;if(h)for(var z=y/o,q=g/r,j=(y+1)/o,_=(g+1)/r,H=0;H<m.length;H++){var U=m[H],W=Math.min(j,U.x1)-Math.max(z,U.x0),F=Math.min(_,U.y1)-Math.max(q,U.y0);if(W>0&&F>0){O=.7*S;break}}var G=S*(1+.3*N)+O;u.push({col:y,row:g,score:G})}}if(!u.length)return;u.sort(function(e,t){return t.score-e.score});for(var V=u[0].score||1,K=u[u.length-1].score||0,Y=V-K||1,Z=0;Z<u.length;Z++)u[Z].norm=(u[Z].score-K)/Y;var J=.75,Q=.5,X=.3,$=10,ee=20,te=25,ae=0,ne=0,oe=0;for(Z=0;Z<u.length;Z++){var re=u[Z],ie=null;if(re.norm>=J&&ae<$)ie="high",ae++;else if(re.norm>=Q&&ne<ee)ie="medium",ne++;else{if(!(re.norm>=X&&oe<te))continue;ie="low",oe++}var le=(re.col+.5)/o*a.width,ce=(re.row+.5)/r*a.height,de=.12*a.width*("high"===ie?1.2:"medium"===ie?1:.8),se=n.createRadialGradient(le,ce,0,le,ce,de);"high"===ie?(se.addColorStop(0,"rgba(255, 0, 0, 0.6)"),se.addColorStop(1,"rgba(255, 0, 0, 0)")):"medium"===ie?(se.addColorStop(0,"rgba(255, 255, 0, 0.5)"),se.addColorStop(1,"rgba(255, 255, 0, 0)")):(se.addColorStop(0,"rgba(0, 255, 0, 0.4)"),se.addColorStop(1,"rgba(0, 255, 0, 0)")),n.fillStyle=se,n.fillRect(0,0,a.width,a.height)}}()}catch(e){console.error("Canvas rendering error:",e),alert("Error rendering visualizations. Results may be incomplete.")}var a,n}(),console.log("=== Analysis Complete ===")}catch(e){throw console.error("Error in performAnalysis:",e),e}}(),console.log("Analysis complete!"),document.getElementById("ac-loadingSection").style.display="none",document.getElementById("ac-resultsSection").style.display="block",n("Analysis complete. Results are now displayed."),document.getElementById("ac-resultsSection").scrollIntoView({behavior:"smooth",block:"start"})}catch(e){console.error("Analysis error:",e),alert("Error analyzing image: "+e.message+"\nPlease try a different image or refresh the page."),n("Error analyzing image. Please try again."),document.getElementById("ac-loadingSection").style.display="none",document.getElementById("ac-formSection").style.display="block"}},100)}catch(e){console.error("Analyze error:",e),alert("Error starting analysis. Please refresh the page and try again."),n("Error starting analysis")}},resetTool:function(){try{e=null,t={},document.getElementById("ac-uploadSection").style.display="block",document.getElementById("ac-formSection").style.display="none",document.getElementById("ac-resultsSection").style.display="none",document.getElementById("ac-photoWarning").classList.remove("show");var a=document.getElementById("ac-ocrStatus");a&&a.parentNode&&a.parentNode.removeChild(a),document.getElementById("ac-wordCountDisplay").style.display="none",document.getElementById("ac-headlineBadge").style.display="none",document.getElementById("ac-ctaBadge").style.display="none",document.getElementById("ac-bodyBadge").style.display="none",document.getElementById("ac-headlineText").classList.remove("ac-auto-filled"),document.getElementById("ac-ctaText").classList.remove("ac-auto-filled"),document.getElementById("ac-bodyText").classList.remove("ac-auto-filled"),document.getElementById("ac-fileInput").value="",document.getElementById("ac-headlineText").value="",document.getElementById("ac-ctaText").value="",document.getElementById("ac-bodyText").value="",document.getElementById("ac-boardType").value="bulletin",document.getElementById("ac-viewingSpeed").value=65,document.getElementById("ac-viewingDistance").value=600,document.getElementById("ac-customSizeGroup").style.display="none",document.getElementById("ac-customHeight").value="";for(var o=document.querySelectorAll(".adcorrector-tool .ac-tab"),r=document.querySelectorAll(".adcorrector-tool .ac-tab-content"),i=0;i<o.length;i++)o[i].classList.remove("active"),o[i].setAttribute("aria-selected","false");for(i=0;i<r.length;i++)r[i].classList.remove("active");o.length>0&&(o[0].classList.add("active"),o[0].setAttribute("aria-selected","true"));var l=document.getElementById("ac-originalTab");l&&l.classList.add("active"),n("Tool reset. Ready for new billboard analysis."),document.querySelector(".adcorrector-tool").scrollIntoView({behavior:"smooth",block:"start"})}catch(e){console.error("Reset error:",e),window.location.reload()}},switchTab:function(e){try{for(var t=document.querySelectorAll(".adcorrector-tool .ac-tab"),a=0;a<t.length;a++)t[a].classList.remove("active"),t[a].setAttribute("aria-selected","false");var o=document.getElementById("tab-"+e);o&&(o.classList.add("active"),o.setAttribute("aria-selected","true"));var r=document.querySelectorAll(".adcorrector-tool .ac-tab-content");for(a=0;a<r.length;a++)r[a].classList.remove("active");var i=document.getElementById("ac-"+e+"Tab");i&&i.classList.add("active");n("Switched to "+({original:"Original design view",speed:"Speed view simulation",heatmap:"Attention heatmap view"}[e]||e))}catch(e){console.error("Tab switch error:",e)}},downloadReport:function(){try{var e=document.getElementById("ac-gradeLetter").textContent,a=(t.readability+t.contrast+t.clarity+t.colors+t.composition+t.cta)/6;"undefined"!=typeof gtag&&gtag("event","download_report",{event_category:"Conversion",event_label:"Report Downloaded",grade:e,overall_score:Math.round(a)}),n("Generating report. Download will begin shortly.");var o=document.createElement("canvas"),r=o.getContext("2d");o.width=1700,o.height=2200,r.fillStyle="white",r.fillRect(0,0,o.width,o.height);var i=r.createLinearGradient(0,0,o.width,0);i.addColorStop(0,"#2389ff"),i.addColorStop(1,"#0f52ba"),r.fillStyle=i,r.fillRect(0,0,o.width,180),r.fillStyle="white",r.font="bold 64px Arial",r.fillText("Ad Corrector Analysis Report",60,90),r.font="28px Arial",r.fillText("Billboard Creative Performance Analysis",60,135);var l=new Date,c=l.toLocaleDateString()+" at "+l.toLocaleTimeString();r.font="20px Arial",r.fillText("Generated: "+c,60,165);var d=220;r.fillStyle="#f8f9ff",r.fillRect(60,d,400,200),r.fillStyle="#2389ff",r.font="bold 140px Arial",r.fillText(e,160,d+140),r.fillStyle="#333",r.font="bold 24px Arial",r.fillText("Overall Grade",130,d+180),r.fillStyle="#333",r.font="bold 32px Arial",r.fillText("Executive Summary",520,d+40);var s=document.getElementById("ac-gradeDescription").textContent;r.font="22px Arial",r.fillStyle="#555";for(var u=s.split(" "),h="",m=d+80,g=0;g<u.length;g++){var y=h+u[g]+" ";r.measureText(y).width>1100&&g>0?(r.fillText(h,520,m),h=u[g]+" ",m+=32):h=y}r.fillText(h,520,m),d=460,r.fillStyle="#333",r.font="bold 28px Arial",f(),r.fillStyle="#333",r.font="bold 28px Arial",r.fillText("Speed View",60,d);var v=document.getElementById("ac-speedCanvas"),p=340,w=v.width/v.height*p;w>800&&(w=800,p=v.height/v.width*w),r.strokeStyle="#ddd",r.lineWidth=2,r.strokeRect(60,d+20,w,p),r.drawImage(v,60,d+20,w,p),r.fillStyle="#333",r.font="bold 28px Arial",r.fillText("Attention Heatmap",900,d);var b=document.getElementById("ac-heatmapCanvas");r.strokeRect(900,d+20,w,p),r.drawImage(b,900,d+20,w,p),d=880,r.fillStyle="#2389ff",r.fillRect(0,d,o.width,4),d+=40,r.fillStyle="#333",r.font="bold 36px Arial",r.fillText("Performance Metrics",60,d);var x={readability:"Readability",contrast:"Contrast",clarity:"Clarity",colors:"Color Harmony",composition:"Composition",cta:"CTA"},M=["readability","contrast","clarity","colors","composition","cta"],C=d+=60,I=520;for(g=0;g<M.length;g++){var E=M[g],B=t&&void 0!==t[E]?t[E]:0,A=x&&x[E]?x[E]:E;if(A){"number"!=typeof B&&(B=parseFloat(B),isNaN(B)&&(B=0));var T=g%3,S=Math.floor(g/3),k=60+580*T,L=C+170*S;r.fillStyle="#f8f9ff",r.fillRect(k,L,I,110),r.fillStyle="#666",r.font="20px Arial",r.fillText(A,k+20,L+35),r.fillStyle="#2389ff",r.font="bold 40px Arial",r.fillText(B+"%",k+20,L+75);var R=320,D=k+I-R-20,P=L+45;r.fillStyle="#e0e0e0",r.fillRect(D,P,R,20);var N=r.createLinearGradient(D,0,D+R,0);N.addColorStop(0,"#2389ff"),N.addColorStop(1,"#0f52ba"),r.fillStyle=N,r.fillRect(D,P,R*(B/100),20)}}d=1360,r.fillStyle="#333",r.font="bold 36px Arial",r.fillText("Key Insights & Recommendations",60,d),d+=50,r.fillStyle="#ff6b6b",r.font="bold 28px Arial";var O="A"===String(e||"").charAt(0)?"Top 3 Recommendations":"Top 3 Improvements";r.fillText(O,60,d),r.fillStyle="#333",r.font="22px Arial",d+=40;var z=document.getElementById("ac-fixesList").getElementsByTagName("li");for(g=0;g<Math.min(z.length,3);g++){var q=z[g].textContent.replace(/^[•·∙]\s*/,"");r.fillText(g+1+". "+q,80,d),d+=35}d+=30,r.fillStyle="#2b8a3e",r.font="bold 28px Arial",r.fillText("What's Working Well",60,d),r.fillStyle="#333",r.font="22px Arial",d+=40;var j=document.getElementById("ac-workingList").getElementsByTagName("li");for(g=0;g<Math.min(j.length,3);g++){var _=j[g].textContent.replace(/^[✓✔☑]\s*/,"");r.fillText("✓ "+_,80,d),d+=35}d+=50,r.fillStyle="#2389ff",r.fillRect(0,d,o.width,4),d+=40,r.fillStyle="#333",r.font="bold 32px Arial",r.fillText("How to Use These Results",60,d),r.font="22px Arial",r.fillStyle="#555",d+=45,r.font="22px Arial",r.fillStyle="#555";var H=[];H.push("Use the Top Improvements above first. Address changes in order of impact."),H.push("After updates, re-analyze to confirm improvements and catch new issues."),H.push("Use the attention heatmap and speed view to validate hierarchy and visibility.");for(g=0;g<H.length;g++)r.fillText(H[g],80,d),d+=38;d=o.height-100,r.fillStyle="#f0f0f0",r.fillRect(0,d,o.width,100),r.fillStyle="#888",r.font="italic 18px Arial",r.fillText("Generated by Ad Corrector - Professional Billboard Analysis Tool",60,d+40),r.fillText("This analysis provides directional guidance. Results are not guarantees of campaign performance.",60,d+65);var U=document.createElement("a");U.download="AdCorrector-Report-"+Date.now()+".png",U.href=o.toDataURL("image/png",1),U.click(),n("Report downloaded successfully")}catch(e){console.error("Report generation error:",e),alert("Error generating report. Please try again."),n("Error generating report")}}}}();function acHasUsableTextInImage(e){if(!e)return!1;var t=e.replace(/\s+/g," ").replace(/[^\w\s.,!?'"-]/g,"").trim();if(t.length<10)return!1;var a=(t.match(/[A-Za-z]/g)||[]).length,n=(t.match(/[^A-Za-z0-9\s]/g)||[]).length;return!(a/t.length<.5)&&!(n/t.length>.3)}function acAnalyzeAd(){AdCorrector.analyzeAd()}function acResetTool(){AdCorrector.resetTool()}function acSwitchTab(e){AdCorrector.switchTab(e)}function acDownloadReport(){AdCorrector.downloadReport()}!function(){var e=document.querySelector(".ac-best-results-note");if(e){for(var t=[document.getElementById("ac-headlineText"),document.getElementById("ac-ctaText"),document.getElementById("ac-bodyText")],a=[],n=0;n<t.length;n++)t[n]&&a.push(t[n]);if(a.length)for(var o=0;o<a.length;o++)(function(t){t.addEventListener("focus",function(){e.classList.add("ac-note-active")}),t.addEventListener("blur",function(){e.classList.remove("ac-note-active")})})(a[o])}}();